name: 'Composer update'
description: 'Runs a composer update and creates a PR if there are any updates'
inputs:
  working-dir:
    description: 'Directory of the composer.lock'
    required: true
    default: './'
  composer-token:
    description: 'API token for composer'
    required: true
  composer-cache:
    description: 'Path to composer cache'
    required: true
    default: /tmp/composer-cache
outputs:
  diff:
    description: "Markdown table with the changed versions"
    value: ${{ steps.get-diff.outputs.diff }}
runs:
  using: "composite"
  steps:
    - name: Install dependencies
      run: composer install ${{ env.COMPOSER_INSTALL_ARGS }}
      env:
        COMPOSER_INSTALL_ARGS: --no-progress --no-scripts --ignore-platform-reqs --no-autoloader -d ${{ inputs.working-dir }}
        COMPOSER_CACHE_DIR: ${{ inputs.composer-cache }}
        COMPOSER_AUTH: '{"github-oauth":{"github.com":"${{ inputs.composer-token }}"}}'

    - name: Update dependencies
      run: composer update ${{ env.COMPOSER_INSTALL_ARGS }}
      env:
        COMPOSER_INSTALL_ARGS: --no-progress --no-scripts --ignore-platform-reqs --no-autoloader -d ${{ inputs.working-dir }}
        COMPOSER_CACHE_DIR: ${{ inputs.composer-cache }}
        COMPOSER_AUTH: '{"github-oauth":{"github.com":"${{ inputs.composer-token }}"}}'

    - name: Create diff
      id: get-diff
      run: |
        composer global require davidrjonas/composer-lock-diff:^1.0
        diff=$(~/.composer/vendor/bin/composer-lock-diff --md -p ${{ inputs.working-dir }})
        diff="${diff//'%'/'%25'}"
        diff="${diff//$'\n'/'%0A'}"
        diff="${diff//$'\r'/'%0D'}"
        echo "::set-output name=diff::$diff"
      env:
        COMPOSER_AUTH: '{"github-oauth":{"github.com":"${{ inputs.composer-token }}"}}'
